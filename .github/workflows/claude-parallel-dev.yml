name: Claude Code ä¸¦åˆ—é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå·'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ã‚¿ã‚¹ã‚¯åˆ†å‰²ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæŠ½å‡ºï¼‰
  task_assignment:
    runs-on: ubuntu-latest
    outputs:
      implementation_tasks: ${{ steps.extract.outputs.implementation_tasks }}
      review_tasks: ${{ steps.extract.outputs.review_tasks }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get Issue Body
        id: get_issue
        uses: actions/github-script@v7
        with:
          script: |
            ISSUE_NUM="${{ github.event.inputs.issue_number || github.event.issue.number }}"
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(ISSUE_NUM)
            });
            core.setOutput('body', issue.data.body);
      - name: Extract implementation tasks from æ©Ÿèƒ½è¦ä»¶
        id: extract
        run: |
          cat > issue_body.md <<EOF
          ${{ steps.get_issue.outputs.body }}
          EOF
          echo "===== issue_body.md ====="
          cat issue_body.md
          echo "===== æ©Ÿèƒ½è¦ä»¶æŠ½å‡º ====="
          awk '/^#+ æ©Ÿèƒ½è¦ä»¶/{flag=1; next} /^#+ /{flag=0} flag && /^-/' issue_body.md | sed 's/^- //' > impl_tasks.txt
          cat impl_tasks.txt
          jq -R -s -c 'split("\n")[:-1]' impl_tasks.txt > impl_tasks.json
          echo "===== impl_tasks.json ====="
          cat impl_tasks.json
          echo "===== GITHUB_OUTPUT ====="
          echo "implementation_tasks=$(cat impl_tasks.json | jq -c .)" >> $GITHUB_OUTPUT
          echo "implementation_tasks=$(cat impl_tasks.json | jq -c .)"

      - name: Extract review tasks from å—ã‘å…¥ã‚ŒåŸºæº–
        run: |
          awk '/^#+ å—ã‘å…¥ã‚ŒåŸºæº–/{flag=1; next} /^## /{flag=0} flag && /^-/' issue_body.md | sed 's/^- //' > review_tasks.txt
          jq -R -s -c 'split("\n")[:-1]' review_tasks.txt > review_tasks.json
          echo "review_tasks=$(cat review_tasks.json)" >> $GITHUB_OUTPUT

  # Claude Code A: å®Ÿè£…
  claude_implementation:
    runs-on: ubuntu-latest
    needs: task_assignment
    strategy:
      matrix:
        task: ${{ fromJson(needs.task_assignment.outputs.implementation_tasks) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: å®Ÿè£…å®Ÿè¡Œ
        run: |
          # ãƒ‡ãƒãƒƒã‚°: matrix.taskã®å†…å®¹ã‚’ç¢ºèª
          echo "matrix.task: '${{ matrix.task }}'"
          
          # ã‚¿ã‚¹ã‚¯å†…å®¹ã‹ã‚‰IDã‚’ç”Ÿæˆ
          TASK_ID=$(echo "${{ matrix.task }}" | head -c 20 | tr ' ' '_' | tr -d '\n')
          echo "TASK_ID: '$TASK_ID'"
          echo "TASK_ID length: ${#TASK_ID}"
          
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b claude-impl-$TASK_ID
          git worktree add ../claude-impl-$TASK_ID claude-impl-$TASK_ID
          cd ../claude-impl-$TASK_ID
          
      - name: Setup Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          claude config set mcp.github.enabled true
          claude config set mcp.github.token $GITHUB_TOKEN
          claude config set mcp.github.repo ${{ github.repository }}
          
      - name: å®Ÿè£…å®Ÿè¡Œ
        run: |
          cd ../claude-impl-$TASK_ID
          claude "${{ matrix.task }}"
          
      - name: PRä½œæˆ
        run: |
          cd ../claude-impl-$TASK_ID
          git push origin claude-impl-$TASK_ID
          claude "å®Ÿè£…å®Œäº†ã€‚PRä½œæˆã—ã¦ãã ã•ã„ã€‚ã‚¿ã‚¤ãƒˆãƒ«: ${{ matrix.task }}"

  # Claude Code B: ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®Ÿè£…å®Œäº†å¾Œï¼‰
  claude_review:
    runs-on: ubuntu-latest
    needs: [task_assignment, claude_implementation]
    strategy:
      matrix:
        task: ${{ fromJson(needs.task_assignment.outputs.review_tasks) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
        run: |
          # ã‚¿ã‚¹ã‚¯å†…å®¹ã‹ã‚‰IDã‚’ç”Ÿæˆ
          TASK_ID=$(echo "${{ matrix.task }}" | head -c 20 | tr ' ' '_' | tr -d '\n')
          echo "TASK_ID: '$TASK_ID'"
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b claude-review-$TASK_ID
          git worktree add ../claude-review-$TASK_ID claude-review-$TASK_ID
          cd ../claude-review-$TASK_ID
          
      - name: Setup Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          claude config set mcp.github.enabled true
          claude config set mcp.github.token $GITHUB_TOKEN
          claude config set mcp.github.repo ${{ github.repository }}
          
      - name: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
        run: |
          cd ../claude-review-$TASK_ID
          claude "æœ€æ–°ã®PRã‚’ç¢ºèªã—ã€å®¢è¦³çš„ãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
          
      - name: PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
        run: |
          claude "ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„"

  # ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã‚ˆã‚‹æœ€çµ‚ãƒã‚§ãƒƒã‚¯
  engineer_final_review:
    runs-on: ubuntu-latest
    needs: [claude_implementation, claude_review]
    steps:
      - name: æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼é€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ” Claude Codeã«ã‚ˆã‚‹å®Ÿè£…ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã‚ˆã‚‹æœ€çµ‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚\n\n- [ ] å®Ÿè£…å†…å®¹ã®ç¢ºèª\n- [ ] ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ\n- [ ] ãƒãƒ¼ã‚¸å¯å¦ã®åˆ¤æ–­'
            });

  # è‡ªå‹•ãƒãƒ¼ã‚¸ï¼ˆæ‰¿èªå¾Œï¼‰
  auto_merge:
    runs-on: ubuntu-latest
    needs: engineer_final_review
    if: contains(github.event.label.name, 'auto-merge-approved')
    steps:
      - name: Auto Merge
        uses: pascalgn/merge-action@v0.15.6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: squash