name: Main Push â†’ Claudeä¸¦åˆ—é–‹ç™º è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼

on:
  push:
    branches: [main]

jobs:
  trigger_claude_development:
    runs-on: ubuntu-latest
    steps:
      - name: æœ€æ–°Issueå–å¾—ã¨ä¸¦åˆ—é–‹ç™ºãƒˆãƒªã‚¬ãƒ¼
        uses: actions/github-script@v7
        with:
          script: |
            console.log(`Main branch push detected: ${context.sha}`);
            
            // æœ€æ–°ã®open Issueã‚’å–å¾—
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 5
            });
            
            if (issues.data.length === 0) {
              console.log('No open issues found');
              return;
            }
            
            // æŠ€è¡“è¦ä»¶ãŒã‚ã‚‹Issueã‚’æ¢ã™
            let targetIssue = null;
            for (const issue of issues.data) {
              const body = issue.body || '';
              const title = issue.title;
              
              // æŠ€è¡“è¦ä»¶ã®åˆ¤å®š
              const isTechnical = /^(feat|fix|refactor|perf|test|docs):/i.test(title) ||
                                body.includes('## æŠ€è¡“è¦ä»¶') ||
                                body.includes('## Technical Requirements') ||
                                body.includes('## æ©Ÿèƒ½è¦ä»¶') ||
                                body.includes('## å—ã‘å…¥ã‚ŒåŸºæº–');
              
              if (isTechnical) {
                targetIssue = issue;
                break;
              }
            }
            
            if (!targetIssue) {
              console.log('No technical issues found');
              return;
            }
            
            console.log(`Found technical issue #${targetIssue.number}: ${targetIssue.title}`);
            
            // claude-dev ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: targetIssue.number,
              labels: ['claude-dev', 'auto-development']
            });
            
            // è‡ªå‹•é–‹ç™ºé–‹å§‹ã‚³ãƒ¡ãƒ³ãƒˆ
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: targetIssue.number,
              body: `ğŸ¤– Mainãƒ–ãƒ©ãƒ³ãƒã®pushã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ\n\n` +
                    `ğŸ“‹ Issue: #${targetIssue.number}\n` +
                    `ğŸ”§ è‡ªå‹•ä¸¦åˆ—é–‹ç™ºã‚’é–‹å§‹ã—ã¾ã™...\n` +
                    `ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${context.sha.substring(0, 7)}`
            });
            
            // ä¸¦åˆ—é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'claude-parallel-dev.yml',
              ref: 'main',
              inputs: {
                issue_number: targetIssue.number.toString()
              }
            });
            
            console.log(`Claude parallel development workflow triggered for issue #${targetIssue.number}`); 